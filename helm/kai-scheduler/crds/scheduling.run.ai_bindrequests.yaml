# Copyright 2025 NVIDIA CORPORATION
# SPDX-License-Identifier: Apache-2.0
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.1
  name: bindrequests.scheduling.run.ai
spec:
  group: scheduling.run.ai
  names:
    kind: BindRequest
    listKind: BindRequestList
    plural: bindrequests
    singular: bindrequest
  scope: Namespaced
  versions:
  - name: v1alpha2
    schema:
      openAPIV3Schema:
        description: BindRequest is the Schema for the bindrequests API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: BindRequestSpec defines the desired state of BindRequest
            properties:
              backoffLimit:
                description: BackoffLimit is the number of retries before giving up
                format: int32
                type: integer
              podName:
                description: PodName is the name of the pod to bind
                type: string
              receivedGPU:
                description: ReceivedGPU is the amount of GPUs that were received
                properties:
                  count:
                    description: Count is the amount of GPUs devices that were received
                    type: integer
                  portion:
                    description: |-
                      This is the portion size that the pod will receive from each connected GPU device
                      This is a serialized float that should be written as a decimal point number.
                    type: string
                type: object
              receivedResourceType:
                description: ReceivedResourceType is the type of the resource that
                  was received [Regular/Fraction]
                type: string
              resourceClaimAllocations:
                description: ResourceClaims is the list of resource claims that need
                  to be bound for this pod
                items:
                  properties:
                    allocation:
                      description: Allocation is the desired allocation of the resource
                        claim
                      properties:
                        allocationTimestamp:
                          description: |-
                            AllocationTimestamp stores the time when the resources were allocated.
                            This field is not guaranteed to be set, in which case that time is unknown.

                            This is an alpha field and requires enabling the DRADeviceBindingConditions and DRAResourceClaimDeviceStatus
                            feature gate.
                          format: date-time
                          type: string
                        devices:
                          description: Devices is the result of allocating devices.
                          properties:
                            config:
                              description: |-
                                This field is a combination of all the claim and class configuration parameters.
                                Drivers can distinguish between those based on a flag.

                                This includes configuration parameters for drivers which have no allocated
                                devices in the result because it is up to the drivers which configuration
                                parameters they support. They can silently ignore unknown configuration
                                parameters.
                              items:
                                description: DeviceAllocationConfiguration gets embedded
                                  in an AllocationResult.
                                properties:
                                  opaque:
                                    description: Opaque provides driver-specific configuration
                                      parameters.
                                    properties:
                                      driver:
                                        description: |-
                                          Driver is used to determine which kubelet plugin needs
                                          to be passed these configuration parameters.

                                          An admission policy provided by the driver developer could use this
                                          to decide whether it needs to validate them.

                                          Must be a DNS subdomain and should end with a DNS domain owned by the
                                          vendor of the driver.
                                        type: string
                                      parameters:
                                        description: |-
                                          Parameters can contain arbitrary data. It is the responsibility of
                                          the driver developer to handle validation and versioning. Typically this
                                          includes self-identification and a version ("kind" + "apiVersion" for
                                          Kubernetes types), with conversion between different versions.

                                          The length of the raw data must be smaller or equal to 10 Ki.
                                        type: object
                                        x-kubernetes-preserve-unknown-fields: true
                                    required:
                                    - driver
                                    - parameters
                                    type: object
                                  requests:
                                    description: |-
                                      Requests lists the names of requests where the configuration applies.
                                      If empty, its applies to all requests.

                                      References to subrequests must include the name of the main request
                                      and may include the subrequest using the format <main request>[/<subrequest>]. If just
                                      the main request is given, the configuration applies to all subrequests.
                                    items:
                                      type: string
                                    type: array
                                    x-kubernetes-list-type: atomic
                                  source:
                                    description: |-
                                      Source records whether the configuration comes from a class and thus
                                      is not something that a normal user would have been able to set
                                      or from a claim.
                                    type: string
                                required:
                                - source
                                type: object
                              type: array
                              x-kubernetes-list-type: atomic
                            results:
                              description: Results lists all allocated devices.
                              items:
                                description: DeviceRequestAllocationResult contains
                                  the allocation result for one request.
                                properties:
                                  adminAccess:
                                    description: |-
                                      AdminAccess indicates that this device was allocated for
                                      administrative access. See the corresponding request field
                                      for a definition of mode.

                                      This is an alpha field and requires enabling the DRAAdminAccess
                                      feature gate. Admin access is disabled if this field is unset or
                                      set to false, otherwise it is enabled.
                                    type: boolean
                                  bindingConditions:
                                    description: |-
                                      BindingConditions contains a copy of the BindingConditions
                                      from the corresponding ResourceSlice at the time of allocation.

                                      This is an alpha field and requires enabling the DRADeviceBindingConditions and DRAResourceClaimDeviceStatus
                                      feature gates.
                                    items:
                                      type: string
                                    type: array
                                    x-kubernetes-list-type: atomic
                                  bindingFailureConditions:
                                    description: |-
                                      BindingFailureConditions contains a copy of the BindingFailureConditions
                                      from the corresponding ResourceSlice at the time of allocation.

                                      This is an alpha field and requires enabling the DRADeviceBindingConditions and DRAResourceClaimDeviceStatus
                                      feature gates.
                                    items:
                                      type: string
                                    type: array
                                    x-kubernetes-list-type: atomic
                                  consumedCapacity:
                                    additionalProperties:
                                      anyOf:
                                      - type: integer
                                      - type: string
                                      pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                      x-kubernetes-int-or-string: true
                                    description: |-
                                      ConsumedCapacity tracks the amount of capacity consumed per device as part of the claim request.
                                      The consumed amount may differ from the requested amount: it is rounded up to the nearest valid
                                      value based on the device’s requestPolicy if applicable (i.e., may not be less than the requested amount).

                                      The total consumed capacity for each device must not exceed the DeviceCapacity's Value.

                                      This field is populated only for devices that allow multiple allocations.
                                      All capacity entries are included, even if the consumed amount is zero.
                                    type: object
                                  device:
                                    description: |-
                                      Device references one device instance via its name in the driver's
                                      resource pool. It must be a DNS label.
                                    type: string
                                  driver:
                                    description: |-
                                      Driver specifies the name of the DRA driver whose kubelet
                                      plugin should be invoked to process the allocation once the claim is
                                      needed on a node.

                                      Must be a DNS subdomain and should end with a DNS domain owned by the
                                      vendor of the driver.
                                    type: string
                                  pool:
                                    description: |-
                                      This name together with the driver name and the device name field
                                      identify which device was allocated (`<driver name>/<pool name>/<device name>`).

                                      Must not be longer than 253 characters and may contain one or more
                                      DNS sub-domains separated by slashes.
                                    type: string
                                  request:
                                    description: |-
                                      Request is the name of the request in the claim which caused this
                                      device to be allocated. If it references a subrequest in the
                                      firstAvailable list on a DeviceRequest, this field must
                                      include both the name of the main request and the subrequest
                                      using the format <main request>/<subrequest>.

                                      Multiple devices may have been allocated per request.
                                    type: string
                                  shareID:
                                    description: |-
                                      ShareID uniquely identifies an individual allocation share of the device,
                                      used when the device supports multiple simultaneous allocations.
                                      It serves as an additional map key to differentiate concurrent shares
                                      of the same device.
                                    type: string
                                  tolerations:
                                    description: |-
                                      A copy of all tolerations specified in the request at the time
                                      when the device got allocated.

                                      The maximum number of tolerations is 16.

                                      This is an alpha field and requires enabling the DRADeviceTaints
                                      feature gate.
                                    items:
                                      description: |-
                                        The ResourceClaim this DeviceToleration is attached to tolerates any taint that matches
                                        the triple <key,value,effect> using the matching operator <operator>.
                                      properties:
                                        effect:
                                          description: |-
                                            Effect indicates the taint effect to match. Empty means match all taint effects.
                                            When specified, allowed values are NoSchedule and NoExecute.
                                          type: string
                                        key:
                                          description: |-
                                            Key is the taint key that the toleration applies to. Empty means match all taint keys.
                                            If the key is empty, operator must be Exists; this combination means to match all values and all keys.
                                            Must be a label name.
                                          type: string
                                        operator:
                                          default: Equal
                                          description: |-
                                            Operator represents a key's relationship to the value.
                                            Valid operators are Exists and Equal. Defaults to Equal.
                                            Exists is equivalent to wildcard for value, so that a ResourceClaim can
                                            tolerate all taints of a particular category.
                                          type: string
                                        tolerationSeconds:
                                          description: |-
                                            TolerationSeconds represents the period of time the toleration (which must be
                                            of effect NoExecute, otherwise this field is ignored) tolerates the taint. By default,
                                            it is not set, which means tolerate the taint forever (do not evict). Zero and
                                            negative values will be treated as 0 (evict immediately) by the system.
                                            If larger than zero, the time when the pod needs to be evicted is calculated as <time when
                                            taint was adedd> + <toleration seconds>.
                                          format: int64
                                          type: integer
                                        value:
                                          description: |-
                                            Value is the taint value the toleration matches to.
                                            If the operator is Exists, the value must be empty, otherwise just a regular string.
                                            Must be a label value.
                                          type: string
                                      type: object
                                    type: array
                                    x-kubernetes-list-type: atomic
                                required:
                                - device
                                - driver
                                - pool
                                - request
                                type: object
                              type: array
                              x-kubernetes-list-type: atomic
                          type: object
                        nodeSelector:
                          description: |-
                            NodeSelector defines where the allocated resources are available. If
                            unset, they are available everywhere.
                          properties:
                            nodeSelectorTerms:
                              description: Required. A list of node selector terms.
                                The terms are ORed.
                              items:
                                description: |-
                                  A null or empty node selector term matches no objects. The requirements of
                                  them are ANDed.
                                  The TopologySelectorTerm type implements a subset of the NodeSelectorTerm.
                                properties:
                                  matchExpressions:
                                    description: A list of node selector requirements
                                      by node's labels.
                                    items:
                                      description: |-
                                        A node selector requirement is a selector that contains values, a key, and an operator
                                        that relates the key and values.
                                      properties:
                                        key:
                                          description: The label key that the selector
                                            applies to.
                                          type: string
                                        operator:
                                          description: |-
                                            Represents a key's relationship to a set of values.
                                            Valid operators are In, NotIn, Exists, DoesNotExist. Gt, and Lt.
                                          type: string
                                        values:
                                          description: |-
                                            An array of string values. If the operator is In or NotIn,
                                            the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                            the values array must be empty. If the operator is Gt or Lt, the values
                                            array must have a single element, which will be interpreted as an integer.
                                            This array is replaced during a strategic merge patch.
                                          items:
                                            type: string
                                          type: array
                                          x-kubernetes-list-type: atomic
                                      required:
                                      - key
                                      - operator
                                      type: object
                                    type: array
                                    x-kubernetes-list-type: atomic
                                  matchFields:
                                    description: A list of node selector requirements
                                      by node's fields.
                                    items:
                                      description: |-
                                        A node selector requirement is a selector that contains values, a key, and an operator
                                        that relates the key and values.
                                      properties:
                                        key:
                                          description: The label key that the selector
                                            applies to.
                                          type: string
                                        operator:
                                          description: |-
                                            Represents a key's relationship to a set of values.
                                            Valid operators are In, NotIn, Exists, DoesNotExist. Gt, and Lt.
                                          type: string
                                        values:
                                          description: |-
                                            An array of string values. If the operator is In or NotIn,
                                            the values array must be non-empty. If the operator is Exists or DoesNotExist,
                                            the values array must be empty. If the operator is Gt or Lt, the values
                                            array must have a single element, which will be interpreted as an integer.
                                            This array is replaced during a strategic merge patch.
                                          items:
                                            type: string
                                          type: array
                                          x-kubernetes-list-type: atomic
                                      required:
                                      - key
                                      - operator
                                      type: object
                                    type: array
                                    x-kubernetes-list-type: atomic
                                type: object
                                x-kubernetes-map-type: atomic
                              type: array
                              x-kubernetes-list-type: atomic
                          required:
                          - nodeSelectorTerms
                          type: object
                          x-kubernetes-map-type: atomic
                      type: object
                    name:
                      description: Name corresponds to the podResourceClaim.Name from
                        the pod spec
                      type: string
                  type: object
                type: array
              selectedGPUGroups:
                description: |-
                  SelectedGPUGroups is the name of the selected GPU groups for fractional GPU resources.
                  Only if the RecievedResourceType is "Fraction"
                items:
                  type: string
                type: array
              selectedNode:
                description: SelectedNode is the name of the selected node the pod
                  should be bound to
                type: string
            type: object
          status:
            description: BindRequestStatus defines the observed state of BindRequest
            properties:
              failedAttempts:
                description: FailedAttempts is the number of failed attempts
                format: int32
                type: integer
              phase:
                description: Phase is the current phase of the bindrequest. [Pending/Succeeded/Failed]
                type: string
              reason:
                description: Reason is the reason for the current phase
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
